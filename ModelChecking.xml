<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE nta PUBLIC '-//Uppaal Team//DTD Flat System 1.1//EN' 'http://www.it.uu.se/research/group/darts/uppaal/flat-1_2.dtd'>
<nta>
	<declaration>// Place global declarations here.
const int N=5;

int[0,N] requester;

int globalTerm;
int heartbeatTerm;
int DtargetTerm;

broadcast chan requestVote;
broadcast chan heartbeat;

broadcast chan requestDismiss;

chan netFail;

int Evotes[N];
int Dvotes;
int numNetFail;</declaration>
	<template>
		<name x="5" y="5">CandidateNode</name>
		<parameter>int[0,5] id</parameter>
		<declaration>// Place local declarations here.
clock electionClock;
clock heartbeatClock;
int term;</declaration>
		<location id="id0" x="1224" y="340">
			<name x="1190" y="306">Candidate</name>
		</location>
		<location id="id1" x="1479" y="340">
			<name x="1470" y="306">Nominee</name>
		</location>
		<location id="id2" x="1717" y="340">
			<name x="1691" y="306">Delegate</name>
			<label kind="invariant" x="1666" y="289">heartbeatClock&lt;=1</label>
		</location>
		<location id="id3" x="1887" y="348">
			<committed/>
		</location>
		<location id="id4" x="1717" y="484">
			<name x="1691" y="493">DNetFail</name>
		</location>
		<location id="id5" x="1147" y="476">
			<name x="1122" y="484">CNetFail</name>
		</location>
		<location id="id6" x="1547" y="459">
			<name x="1521" y="467">NNetFail</name>
		</location>
		<init ref="id0"/>
		<transition>
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="select" x="1487" y="68">rand:int[2,4]</label>
			<label kind="guard" x="1487" y="85">Evotes[id]&lt;N/2+1 &amp;&amp; electionClock&gt;=rand</label>
			<label kind="synchronisation" x="1487" y="102">requestVote!</label>
			<label kind="assignment" x="1487" y="119">requester=id,
globalTerm=(++globalTerm)%10,
term=globalTerm,
Evotes[id]:=1</label>
			<nail x="1496" y="127"/>
			<nail x="1581" y="161"/>
		</transition>
		<transition>
			<source ref="id6"/>
			<target ref="id1"/>
			<label kind="assignment" x="1530" y="416">numNetFail--</label>
			<nail x="1530" y="382"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id6"/>
			<label kind="synchronisation" x="1479" y="382">netFail?</label>
			<label kind="assignment" x="1479" y="399">numNetFail++</label>
			<nail x="1496" y="416"/>
		</transition>
		<transition>
			<source ref="id5"/>
			<target ref="id0"/>
			<label kind="assignment" x="1156" y="416">electionClock:=0,
numNetFail--</label>
			<nail x="1215" y="425"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id5"/>
			<label kind="synchronisation" x="1139" y="382">netFail?</label>
			<label kind="assignment" x="1088" y="425">numNetFail++</label>
			<nail x="1139" y="416"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="guard" x="986" y="221">Dvotes==0</label>
			<label kind="synchronisation" x="986" y="238">requestDismiss!</label>
			<label kind="assignment" x="986" y="255">Dvotes:=0,
DtargetTerm=heartbeatTerm</label>
			<nail x="1096" y="314"/>
			<nail x="1139" y="255"/>
		</transition>
		<transition>
			<source ref="id4"/>
			<target ref="id2"/>
			<label kind="assignment" x="1725" y="416">heartbeatClock:=0,
numNetFail--</label>
			<nail x="1760" y="408"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id4"/>
			<label kind="synchronisation" x="1649" y="408">netFail?</label>
			<label kind="assignment" x="1649" y="425">numNetFail++</label>
			<nail x="1674" y="408"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id3"/>
			<label kind="guard" x="1742" y="246">heartbeatClock&gt;=1</label>
			<label kind="assignment" x="1734" y="263">heartbeatTerm=term</label>
			<nail x="1802" y="280"/>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="guard" x="1428" y="501">term&lt;heartbeatTerm</label>
			<label kind="synchronisation" x="1428" y="518">heartbeat?</label>
			<label kind="assignment" x="1428" y="535">electionClock:=0,
Dvotes:=0</label>
			<nail x="1496" y="544"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="1402" y="255">requestDismiss?</label>
			<label kind="assignment" x="1427" y="272">Dvotes++</label>
			<nail x="1402" y="272"/>
			<nail x="1470" y="238"/>
		</transition>
		<transition>
			<source ref="id3"/>
			<target ref="id2"/>
			<label kind="synchronisation" x="1751" y="340">heartbeat!</label>
			<label kind="assignment" x="1751" y="357">heartbeatClock:=0</label>
			<nail x="1802" y="399"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="1343" y="357">heartbeat?</label>
			<label kind="assignment" x="1343" y="374">electionClock:=0,
Evotes[id]:=0</label>
			<nail x="1326" y="399"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id1"/>
			<label kind="select" x="1283" y="229">rand:int[2,4]</label>
			<label kind="guard" x="1283" y="246">electionClock&gt;=rand</label>
			<label kind="synchronisation" x="1283" y="263">requestVote!</label>
			<label kind="assignment" x="1266" y="280">requester=id,
globalTerm=(++globalTerm)%10,
term=globalTerm,
Evotes[id]++</label>
		</transition>
		<transition>
			<source ref="id2"/>
			<target ref="id0"/>
			<label kind="guard" x="1555" y="212">term==DtargetTerm &amp;&amp; Dvotes&gt;=N/2+1</label>
			<label kind="assignment" x="1555" y="229">Dvotes:=0,
electionClock:=0</label>
			<nail x="1487" y="195"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="1037" y="348">requestDismiss?</label>
			<label kind="assignment" x="1037" y="365">Dvotes++</label>
			<nail x="1096" y="340"/>
			<nail x="1113" y="391"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id1"/>
			<label kind="synchronisation" x="1394" y="416">requestVote?</label>
			<label kind="assignment" x="1377" y="433">Evotes[requester]++</label>
			<nail x="1419" y="425"/>
			<nail x="1470" y="450"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="1190" y="221">heartbeat?</label>
			<label kind="assignment" x="1164" y="246">electionClock:=0</label>
			<nail x="1173" y="246"/>
			<nail x="1284" y="246"/>
		</transition>
		<transition>
			<source ref="id0"/>
			<target ref="id0"/>
			<label kind="synchronisation" x="1216" y="451">requestVote?</label>
			<label kind="assignment" x="1215" y="467">Evotes[requester]++</label>
			<nail x="1232" y="450"/>
			<nail x="1300" y="450"/>
		</transition>
		<transition>
			<source ref="id1"/>
			<target ref="id2"/>
			<label kind="guard" x="1538" y="314">Evotes[id]&gt;=N/2+1</label>
			<label kind="assignment" x="1538" y="340">heartbeatTerm=term,
Evotes[id]:=0,
heartbeatClock:=0</label>
		</transition>
	</template>
	<template>
		<name>VotingNode</name>
		<location id="id7" x="-221" y="-68">
			<name x="-231" y="-102">Voting</name>
		</location>
		<location id="id8" x="-221" y="-178">
			<name x="-246" y="-212">VNetFail</name>
		</location>
		<init ref="id7"/>
		<transition>
			<source ref="id8"/>
			<target ref="id7"/>
			<label kind="assignment" x="-199" y="-157">numNetFail--</label>
			<nail x="-178" y="-136"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id8"/>
			<label kind="synchronisation" x="-280" y="-153">netFail?</label>
			<label kind="assignment" x="-280" y="-136">numNetFail++</label>
			<nail x="-263" y="-136"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id7"/>
			<label kind="guard" x="-161" y="-119">Dvotes==0</label>
			<label kind="synchronisation" x="-161" y="-102">requestDismiss!</label>
			<label kind="assignment" x="-161" y="-85">Dvotes:=0,
DtargetTerm=heartbeatTerm</label>
			<nail x="-144" y="-119"/>
			<nail x="-144" y="-25"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-399" y="-102">requestDismiss?</label>
			<label kind="assignment" x="-399" y="-85">Dvotes++</label>
			<nail x="-289" y="-127"/>
			<nail x="-289" y="-25"/>
		</transition>
		<transition>
			<source ref="id7"/>
			<target ref="id7"/>
			<label kind="synchronisation" x="-272" y="-25">requestVote?</label>
			<label kind="assignment" x="-280" y="0">Evotes[requester]++</label>
			<nail x="-272" y="0"/>
			<nail x="-187" y="0"/>
		</transition>
	</template>
	<template>
		<name>NetConnection</name>
		<location id="id9" x="0" y="0">
		</location>
		<init ref="id9"/>
		<transition>
			<source ref="id9"/>
			<target ref="id9"/>
			<label kind="synchronisation" x="-34" y="-110">netFail!</label>
			<nail x="-76" y="-85"/>
			<nail x="68" y="-85"/>
		</transition>
	</template>
	<system>// Place template instantiations here.
CNode1 := CandidateNode(0);
CNode2 := CandidateNode(1);
CNode3 := CandidateNode(2);
VNode1 := VotingNode();
VNode2 := VotingNode();
netConn := NetConnection();

// List one or more processes to be composed into a system.
system CNode1, CNode2, CNode3, 
        VNode1, VNode2,
        netConn;</system>
	<queries>
		<query>
			<formula>A&lt;&gt; (CNode1.Delegate + CNode2.Delegate + CNode3.Delegate &gt;= 2) imply (CNode1.Delegate + CNode2.Delegate + CNode3.Delegate == 1)</formula>
			<comment>(Liveness) 2개 이상의 대표노드가 존재할 시, 결국 1개의 대표노드로 줄어든다.</comment>
		</query>
		<query>
			<formula>E&lt;&gt; CNode1.Delegate or CNode2.Delegate or CNode3.Delegate</formula>
			<comment>(Reachability) Delegate 상태에 도달가능하다.</comment>
		</query>
		<query>
			<formula>E&lt;&gt; CNode1.Delegate or CNode2.Delegate or CNode3.Delegate and Dvotes&gt;=N/2+1</formula>
			<comment>(Reachability) 대표노드는 해임 투표를 통해 과반수를 득표할 수 있다.</comment>
		</query>
		<query>
			<formula>E&lt;&gt; (CNode1.Nominee and Evotes[0]&gt;=N/2+1) or (CNode2.Nominee and Evotes[1]&gt;=N/2+1) or (CNode3.Nominee and Evotes[2]&gt;=N/2+1)</formula>
			<comment>(Reachability) Nominee 노드는 대료노드의 선출 투표를 통해 과반수를 득표할 수 있다.</comment>
		</query>
		<query>
			<formula>E&lt;&gt; CNode1.Nominee and CNode2.Nominee and CNode3.Nominee</formula>
			<comment>(Reachability) 모든 후보노드는 투표를 요청하여 다함께 Nominee 상태가 될 수 있다.</comment>
		</query>
		<query>
			<formula>A[] forall(i:int[0,N-1]) (Evotes[i]&gt;=0 and Evotes[i]&lt;=N)</formula>
			<comment>(Safety) 모든 노드는 최대 노드 수만큼 득표 가능하다.</comment>
		</query>
		<query>
			<formula>A[] not deadlock</formula>
			<comment>(Safety) 데드락이 발생하지 않는다.</comment>
		</query>
		<query>
			<formula>A&lt;&gt; numNetFail&gt;=N/2+1 and CNode1.Candidate imply CNode1.Delegate</formula>
			<comment>(Liveness) 반 수 이상의 노드가 failure되지 않는 이상 대표노드는 뽑힌다.
</comment>
		</query>
	</queries>
</nta>
